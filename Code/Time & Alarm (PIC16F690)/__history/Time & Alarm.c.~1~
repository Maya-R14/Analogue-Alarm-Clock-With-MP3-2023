#include <Set_Time.h>
#include <DS3231.h>
#include <Stepper_Header_V2.h>
#Include <Steps_2_time.h>

#byte TRISA = 0X85
#byte PORTA = 0x05
#bit A2 = 0x05.2
#bit A4 = 0x05.4
#bit A5 = 0x05.5

#byte PORTB = 0x06
#byte TRISB = 0X86
#bit B4 = 0x06.4
#bit B5 = 0x06.5
#bit B6 = 0x06.6
#bit B7 = 0x06.7

#byte PORTC = 0x07
#byte TRISC = 0x87
#bit C0 = 0x07.0
#bit C1 = 0x07.1
#bit C2 = 0x07.2
#bit C3 = 0x07.3
//#bit C4 = 0x07.4
//#bit C5 = 0x07.5
//#bit C6 = 0x07.6
//#bit C7 = 0x07.7
int16 time_min;
int16 time_hr;

void Adjust_time(VOID);
void display_time(VOID);

int Adjust_Time_tog;
int hr_or_min;

#INT_RA
void  RA_isr(VOID) 
{
   IF (hr_or_min == 0)
   {
      IF (A4 == 1&&A5 == 1) S2_Setpoint += 17; 
      IF (A4 == 0&&A5 == 1) S2_Setpoint -= 17; //maybe change to 85.
   }

   IF (hr_or_min == 1)
   {
      IF (A4 == 1&&A5 == 1) S1_Setpoint += 17; 
      IF (A4 == 0&&A5 == 1) S1_Setpoint -=  17;
   }
}

void main()
{
   Enable_Steppers ();
   
   TRISA = 0xff;
   TRISB = 0xff;
   TRISC = 0XFF;
   
   enable_interrupts (GLOBAL) ;
   
   Time_hr = 12;
   Time_min = 0;
   Adjust_Time_tog = 1;
   
   WHILE (TRUE)
   {
      IF (B5 == 1) Adjust_Time_tog = ! Adjust_Time_tog;
      
      IF (Adjust_Time_tog == 1)
      {
         enable_interrupts (INT_RA5);
         Adjust_time () ;
      }

      
      ELSE
      {
         disable_interrupts (INT_RA5);
         Display_time ();
      }

   }
}

void Adjust_time(VOID)
{
   IF (A2 == 0) hr_or_min = ! hr_or_min; //Toggle Button
   Stepper1 (S1_Setpoint) ;
   Stepper2 (S2_Setpoint) ;
   Overflow_Protect () ;

   IF (C0 == 1) Set_Time (Steps_2_hr (S2_Setpoint), Steps_2_min (S1_Setpoint), PM);
   IF (C0 == 0) Set_Time (Steps_2_hr (S2_Setpoint), Steps_2_min (S1_Setpoint), AM);
}

void display_time(VOID)
{
   //// Minutes and Stepper1 ////
   Time_min = Read_time_DEC (0x01);
   
   IF (Time_min == 0&&S1_Current_Pos != 1000)
   {
      Stepper1 (3048);
      S1_Current_Pos = 1000;
   }

   ELSE Stepper1 (Min_2_Steps (Time_min)) ;
   
   //// Hours and Stepper2 ////
   time_hr = (0x1F&Read_time_BCD (0x02));
   time_hr = BCD_2_DEC (time_hr);
   
   IF (Time_min == 0&&time_hr == 1&&S2_Current_Pos != 1170)
   {
      Stepper2 (3218);
      S2_Current_Pos = 1170;
   }

   ELSE Stepper2 (hours (time_hr, Time_min));
}

